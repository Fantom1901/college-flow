# üîå Nixa Duty Core | TOTAL API SPECIFICATION v1.0
> **Architect:** Nixa_io (–¢–∏–º–æ—Ñ–µ–π)
> **Contact:** @Nixa_io (Telegram)
> **Security:** TG InitData Validation

---

## 1. –§–£–ù–î–ê–ú–ï–ù–¢ –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### 1.1 –ë–∞–∑–æ–≤—ã–π URL
`***`

### 1.2 –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Telegram WebApp Auth)
–ê—Ä–∫–∞–¥–∏–π –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ –∫–∞–∂–¥–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç Telegram. –ù–∞ –±–µ–∫—ç–Ω–¥–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è.
- **Header:** `Authorization: <window.Telegram.WebApp.initData>`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ë—ç–∫–µ–Ω–¥ –≤—ã—á–∏—Å–ª—è–µ—Ç HMAC-SHA256, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ö–µ—à –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `user.id`.

### 1.3 –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤
- `200 OK`: –£—Å–ø–µ—Ö.
- `201 Created`: –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å (–∏–Ω–≤–∞–π—Ç, –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–º–µ–Ω).
- `401 Unauthorized`: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¢–µ–ª–µ–≥—Ä–∞–º–∞.
- `403 Forbidden`: –°—Ç—É–¥–µ–Ω—Ç –ª–µ–∑–µ—Ç –≤ –∞–¥–º–∏–Ω–∫—É –∏–ª–∏ –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —á—É–∂–æ–π –æ–±–º–µ–Ω.
- `422 Unprocessable Entity`: –û—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±–º–µ–Ω —Å —Å–∞–º–∏–º —Å–æ–±–æ–π).

---

## 2. –°–£–©–ù–û–°–¢–ò –ò –°–í–Ø–ó–ò (DATA MODELS)

### 2.1 –ò–µ—Ä–∞—Ä—Ö–∏—è —Å–≤—è–∑–µ–π:
1. **Group** (–ì—Ä—É–ø–ø–∞) ‚Äî –∫–æ—Ä–µ–Ω—å —Å–∏—Å—Ç–µ–º—ã.
2. **User** (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) ‚Äî —Å–≤—è–∑–∞–Ω —Å –æ–¥–Ω–æ–π –ì—Ä—É–ø–ø–æ–π. –ò–º–µ–µ—Ç `role` (superadmin, admin, moderator, user).
3. **Duty** (–î–µ–∂—É—Ä—Å—Ç–≤–æ) ‚Äî –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –î–∞—Ç–µ, –ì—Ä—É–ø–ø–µ –∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
4. **Swap** (–û–±–º–µ–Ω) ‚Äî —Å–≤—è–∑—ã–≤–∞–µ—Ç –¥–≤—É—Ö –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–≤–µ –î–∞—Ç—ã –¥–µ–∂—É—Ä—Å—Ç–≤.
5. **Attendance** (–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å) ‚Äî —Å–≤—è–∑—ã–≤–∞–µ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –î–∞—Ç—É –∏ –°—Ç–∞—Ç—É—Å (present/absent).

---

## 3. –≠–ù–î–ü–û–ò–ù–¢–´ (ENDPOINTS)

### 3.1 –ì—Ä—É–ø–ø—ã –∏ –ü—Ä–æ—Ñ–∏–ª—å
- `GET /me` ‚Äî –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ –æ —Å–µ–±–µ, —Å–≤–æ–µ–π —Ä–æ–ª–∏ –∏ —Å–≤–æ–µ–π –≥—Ä—É–ø–ø–µ.
- `GET /group/members` ‚Äî –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø—ã (ID, –∏–º—è, –≤–µ—Å, –∫–æ–ª-–≤–æ –¥–µ–∂—É—Ä—Å—Ç–≤).
- `POST /group/invite/generate` ‚Äî (Admin/Moder) –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.
- `PATCH /group/settings` ‚Äî (Admin/Moder) –°–º–µ–Ω–∞ –º–µ—Ç–æ–¥–∞ (weight/static).

### 3.2 –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –î–µ–∂—É—Ä—Å—Ç–≤–∞
- `GET /duty/schedule?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD` ‚Äî –°–ø–∏—Å–æ–∫ –¥–µ–∂—É—Ä–Ω—ã—Ö –Ω–∞ –ø–µ—Ä–∏–æ–¥.
- `GET /duty/today` ‚Äî –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ñ–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å.
- `POST /duty/mark-completed` ‚Äî (Moder) –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —á—Ç–æ –¥–µ–∂—É—Ä—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–Ω–∞—á–∏—Å–ª—è–µ—Ç +1 –∫ –≤–µ—Å—É).

### 3.3 –°–∏—Å—Ç–µ–º–∞ –û–±–º–µ–Ω–∞ (Swap System) ‚Äî –ü–û–î–†–û–ë–ù–û
1. **–°–æ–∑–¥–∞–Ω–∏–µ:** `POST /swaps/request`
   - *Body:* `{"to_user_id": int, "my_date": "date", "target_date": "date"}`
2. **–°–ø–∏—Å–æ–∫ –≤—Ö–æ–¥—è—â–∏—Ö:** `GET /swaps/incoming` ‚Äî –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç –æ—Ç–≤–µ—Ç–∞ —é–∑–µ—Ä–∞.
3. **–°–ø–∏—Å–æ–∫ –∏—Å—Ö–æ–¥—è—â–∏—Ö:** `GET /swaps/outgoing` ‚Äî –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —é–∑–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–∞–º.
4. **–†–µ—à–µ–Ω–∏–µ:** `POST /swaps/{id}/decision`
   - *Body:* `{"status": "accepted" | "declined"}`
   - *Logic:* –ü—Ä–∏ `accepted` –±—ç–∫–µ–Ω–¥ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–µ–Ω—è–µ—Ç `user_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `DutySchedule` –¥–ª—è –æ–±–µ–∏—Ö –¥–∞—Ç.

### 3.4 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ß–µ—Å—Ç–Ω–æ—Å—Ç—å
- `GET /stats/leaderboard` ‚Äî –°–ø–∏—Å–æ–∫ –≤—Å–µ–π –≥—Ä—É–ø–ø—ã, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ `duty_count` (–∫—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ—Ö —Ä–∞–±–æ—Ç–∞–ª) –∏–ª–∏ –ø–æ `weight` (–∫—Ç–æ –ø–µ—Ä–≤—ã–π –Ω–∞ –≤—ã–ª–µ—Ç).
- `GET /stats/attendance` ‚Äî –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –î–∏–∞–Ω—ã.

---

## 4. –ü–û–î–†–û–ë–ù–ê–Ø –õ–û–ì–ò–ö–ê –ê–õ–ì–û–†–ò–¢–ú–û–í (BACKEND ONLY)

### 4.1 –ú–µ—Ç–æ–¥ "–í–µ—Å" (Weight Algorithm)
–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –¥–µ–∂—É—Ä—Å—Ç–≤–∞:
1. –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö `User` –≥—Ä—É–ø–ø—ã.
2. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ `weight` (ASC) –∏ `last_duty_date` (ASC).
3. –í–∑—è—Ç—å –ø–µ—Ä–≤–æ–≥–æ.
4. –ü–æ—Å–ª–µ –¥–µ–∂—É—Ä—Å—Ç–≤–∞: `weight = weight + 1`.

### 4.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤
–ï—Å–ª–∏ `Attendance.status == "absent"` –≤ –¥–µ–Ω—å –¥–µ–∂—É—Ä—Å—Ç–≤–∞:
- –í–µ—Å **–ù–ï** —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
- –°—Ç—É–¥–µ–Ω—Ç –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Ç–æ–ø–µ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –¥–∞—Ç—É.

---

## 5. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (FRONT-BACK)

### –§–æ—Ä–º–∞—Ç –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏
–í—Å–µ–≥–¥–∞ JSON. –î–∞—Ç—ã –≤—Å–µ–≥–¥–∞ `YYYY-MM-DD`.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (Member Card):**
```json
{
  "user_id": 77,
  "name": "–ê—Ä–∫–∞–¥–∏–π",
  "stats": {
    "total_duties": 5,
    "weight": 2,
    "absences": 0
  },
  "is_on_duty_today": false
}